import{F as ie,u as de}from"./provide.9d38a7a3.js";import{I as ue}from"./index.753ed6d4.js";import{P as me}from"./index.d0cb3da2.js";import{I as ce}from"./index.c3e80338.js";import{R as pe}from"./index.08cd40ac.js";import{d as g,i as ve,f as c,c as fe}from"./components.011f3236.js";import{d as ge,a as U,b as q,X as ye,w as he,W as Q,r as A,n as be,Z as X,_ as Ve,p as F,ag as we,f as p,h as v,M as w,F as Re,ai as Pe,D as Z,N as t,Q as Ce,ah as $e,q as R,j as P,R as Be,O as ke,S as Se}from"./vue-router.esm-bundler.5eeb4635.js";import{i as G,a as J}from"./shared.f77a40d1.js";const De={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:g(),onAfterRead:g(),onBeforeRemove:g(),onRemove:g(),onOversize:g(),"onUpdate:modelValue":g()},{n:Le,classes:Ue}=fe("uploader");let Ae=0;const Fe=ge({name:"VarUploader",directives:{Ripple:pe},components:{VarIcon:ue,VarPopup:me,VarFormDetails:ie},props:De,setup(e){const d=U(null),C=U(!1),$=U(null),N=q(()=>{const{maxlength:a,modelValue:{length:n}}=e;return ye(a)?`${n} / ${a}`:""}),{form:s,bindForm:h}=de(),{errorMessage:B,validateWithTrigger:k,validate:b,resetValidation:l}=ve(),f=q(()=>{const{modelValue:a,hideList:n}=e;return n?[]:a}),K=()=>{d.value.click()},Y=a=>{const{disabled:n,readonly:o,previewed:r}=e;if((s==null?void 0:s.disabled.value)||(s==null?void 0:s.readonly.value)||n||o||!r)return;const{url:i}=a;if(Q(i)&&J(i)){ce(i);return}Q(i)&&G(i)&&($.value=a,C.value=!0)},_=a=>({id:Ae++,url:"",cover:"",name:a.name,file:a}),x=a=>{const n=a.target,{files:o}=n;return Array.from(o)},ee=a=>new Promise(n=>{const o=new FileReader;o.onload=()=>{const r=o.result;a.file.type.startsWith("image")&&(a.cover=r),a.url=r,n(a)},o.readAsDataURL(a.file)}),ae=a=>a.map(ee),le=a=>{const{onBeforeRead:n}=e;return a.map(o=>new Promise(r=>{const i=n?n(A(o)):!0;Promise.resolve(i).then(y=>r({valid:y,varFile:o}))}))},se=async a=>{const{maxsize:n,maxlength:o,modelValue:r,onOversize:i,onAfterRead:y,readonly:D,disabled:L}=e;if((s==null?void 0:s.disabled.value)||(s==null?void 0:s.readonly.value)||L||D)return;const oe=u=>u.filter(V=>V.file.size>X(n)?(c(i,A(V)),!1):!0),re=u=>{const V=Math.min(u.length,X(o)-r.length);return u.slice(0,V)};let m=x(a).map(_);m=n!=null?oe(m):m,m=o!=null?re(m):m;const te=await Promise.all(ae(m)),j=(await Promise.all(le(te))).filter(({valid:u})=>u).map(({varFile:u})=>u);c(e["onUpdate:modelValue"],[...r,...j]),a.target.value="",j.forEach(u=>c(y,A(u)))},ne=async a=>{const{disabled:n,readonly:o,modelValue:r,onBeforeRemove:i,onRemove:y}=e;if((s==null?void 0:s.disabled.value)||(s==null?void 0:s.readonly.value)||n||o||i&&!await i(a))return;const D=r.filter(L=>L!==a);c(y,a),E("onRemove"),c(e["onUpdate:modelValue"],D)},z=()=>e.modelValue.filter(a=>a.state==="success"),M=()=>e.modelValue.filter(a=>a.state==="error"),I=()=>e.modelValue.filter(a=>a.state==="loading"),W={getSuccess:z,getError:M,getLoading:I},E=a=>{be(()=>{const{validateTrigger:n,rules:o,modelValue:r}=e;k(n,a,o,r,W)})};let S=!1;const H=()=>b(e.rules,e.modelValue,W),O=()=>{S=!0,c(e["onUpdate:modelValue"],[]),l()};return c(h,{validate:H,resetValidation:l,reset:O}),he(()=>e.modelValue,()=>{!S&&E("onChange"),S=!1},{deep:!0}),{n:Le,classes:Ue,input:d,files:f,showPreview:C,currentPreview:$,errorMessage:B,maxlengthText:N,isHTMLSupportVideo:G,isHTMLSupportImage:J,formDisabled:s==null?void 0:s.disabled,formReadonly:s==null?void 0:s.readonly,preview:Y,triggerAction:K,handleChange:se,handleRemove:ne,getSuccess:z,getError:M,getLoading:I,validate:H,resetValidation:l,reset:O}}});const Te=["onClick"],Ne=["onClick"],ze=["src","alt"],Me=["multiple","accept","capture","disabled"],Ie=["src"];function We(e,d,C,$,N,s){const h=F("var-icon"),B=F("var-form-details"),k=F("var-popup"),b=we("ripple");return p(),v("div",{class:t(e.classes(e.n(),e.n("$--box")))},[w("div",{class:t(e.n("file-list"))},[(p(!0),v(Re,null,Pe(e.files,l=>Z((p(),v("div",{class:t(e.classes(e.n("file"),e.n("$-elevation--2"),[l.state==="loading",e.n("--loading")])),key:l.id,onClick:f=>e.preview(l)},[w("div",{class:t(e.n("file-name"))},Ce(l.name||l.url),3),e.removable?(p(),v("div",{key:0,class:t(e.n("file-close")),onClick:$e(f=>e.handleRemove(l),["stop"])},[R(h,{class:t(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ne)):P("",!0),l.cover?(p(),v("img",{key:1,class:t(e.n("file-cover")),style:Be({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,ze)):P("",!0),w("div",{class:t(e.classes(e.n("file-indicator"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")]))},null,2)],10,Te)),[[b,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?Z((p(),v("div",{key:0,class:t(e.classes([!e.$slots.default,`${e.n("action")} ${e.n("$-elevation--2")}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...l)=>e.triggerAction&&e.triggerAction(...l))},[w("input",{ref:"input",class:t(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,Me),ke(e.$slots,"default",{},()=>[R(h,{class:t(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[b,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):P("",!0)],2),R(B,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),R(k,{class:t(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=l=>e.showPreview=l),onClosed:d[3]||(d[3]=l=>e.currentPreview=null)},{default:Se(()=>{var l,f;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(p(),v("video",{key:0,class:t(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(f=e.currentPreview)==null?void 0:f.url},null,10,Ie)):P("",!0)]}),_:1},8,["class","show"])],2)}const T=Ve(Fe,[["render",We]]);T.install=function(e){e.component(T.name,T)};export{T as U};
