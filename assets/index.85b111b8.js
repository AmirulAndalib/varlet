import{F as re,u as te}from"./provide.538f2bd7.js";import{I as ie}from"./index.e30cf35b.js";import{P as de}from"./index.43dd9647.js";import{I as ue}from"./index.9497d8ab.js";import{R as ce}from"./index.c3ac679f.js";import{d as me,r as D,A as pe,b as O,y as ve,q as U,z as fe,e as L,f as ge,o as m,c as p,a as V,F as ye,k as he,w as q,p as t,t as be,R as Ve,i as w,h as R,n as we,G as Re,j as Pe}from"./vendor.49f89f0d.js";import{d as Ce,a as v,C as G,D as J,c as Be,i as Fe,g as K,t as Q}from"./components.5cba9644.js";import{_ as ke}from"./elevation.4d11ec3f.js";const $e={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:{type:Function},onAfterRead:{type:Function},onBeforeRemove:{type:Function},onRemove:{type:Function},onOversize:{type:Function},"onUpdate:modelValue":{type:Function}};const{n:Se,classes:De}=Be("uploader");let Ue=0;const Le=me({name:"VarUploader",directives:{Ripple:ce},components:{VarIcon:ie,VarPopup:de,VarFormDetails:re},props:$e,setup(e){const u=D(`var-uploader-${pe().uid}`),P=D(!1),C=D(null),z=O(()=>{const{maxlength:a,modelValue:{length:n}}=e;return Fe(a)?`${n} / ${a}`:""}),{form:l,bindForm:y}=te(),{errorMessage:B,validateWithTrigger:F,validate:h,resetValidation:s}=Ce(),f=O(()=>{const{modelValue:a,hideList:n}=e;return n?[]:a}),X=a=>{const{disabled:n,readonly:o,previewed:r}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||n||o||!r)return;const{url:i}=a;if(K(i)&&J(i)){ue(i);return}K(i)&&G(i)&&(C.value=a,P.value=!0)},Y=a=>({id:Ue++,url:"",cover:"",name:a.name,file:a}),Z=a=>{const n=a.target,{files:o}=n;return Array.from(o)},_=a=>new Promise(n=>{const o=new FileReader;o.onload=()=>{const r=o.result;a.file.type.startsWith("image")&&(a.cover=r),a.url=r,n(a)},o.readAsDataURL(a.file)}),x=a=>a.map(_),ee=a=>{const{onBeforeRead:n}=e;return a.map(o=>new Promise(r=>{const i=n?n(U(o)):!0;Promise.resolve(i).then(g=>r({valid:g,varFile:o}))}))},ae=async a=>{const{maxsize:n,maxlength:o,modelValue:r,onOversize:i,onAfterRead:g,readonly:$,disabled:S}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||S||$)return;const se=d=>d.filter(b=>b.file.size>Q(n)?(v(i,U(b)),!1):!0),ne=d=>{const b=Math.min(d.length,Q(o)-r.length);return d.slice(0,b)};let c=Z(a).map(Y);c=n!=null?se(c):c,c=o!=null?ne(c):c;const oe=await Promise.all(x(c)),j=(await Promise.all(ee(oe))).filter(({valid:d})=>d).map(({varFile:d})=>d);v(e["onUpdate:modelValue"],[...r,...j]),a.target.value="",j.forEach(d=>v(g,U(d)))},le=async a=>{const{disabled:n,readonly:o,modelValue:r,onBeforeRemove:i,onRemove:g}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||n||o||i&&!await i(a))return;const $=r.filter(S=>S!==a);v(g,a),E("onRemove"),v(e["onUpdate:modelValue"],$)},A=()=>e.modelValue.filter(a=>a.state==="success"),N=()=>e.modelValue.filter(a=>a.state==="error"),I=()=>e.modelValue.filter(a=>a.state==="loading"),M={getSuccess:A,getError:N,getLoading:I},E=a=>{fe(()=>{const{validateTrigger:n,rules:o,modelValue:r}=e;F(n,a,o,r,M)})};let k=!1;const H=()=>h(e.rules,e.modelValue,M),W=()=>{k=!0,v(e["onUpdate:modelValue"],[]),s()};return v(y,{validate:H,resetValidation:s,reset:W}),ve(()=>e.modelValue,()=>{!k&&E("onChange"),k=!1},{deep:!0}),{n:Se,classes:De,id:u,files:f,showPreview:P,currentPreview:C,errorMessage:B,maxlengthText:z,isHTMLSupportVideo:G,isHTMLSupportImage:J,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,preview:X,handleChange:ae,handleRemove:le,getSuccess:A,getError:N,getLoading:I,validate:H,resetValidation:s,reset:W}}}),Te=["onClick"],ze=["onClick"],Ae=["src","alt"],Ne=["for"],Ie=["id","multiple","accept","capture","disabled"],Me=["src"];function Ee(e,u,P,C,z,l){const y=L("var-icon"),B=L("var-form-details"),F=L("var-popup"),h=ge("ripple");return m(),p("div",{class:t(e.classes(e.n(),"var--box"))},[V("div",{class:t(e.n("file-list"))},[(m(!0),p(ye,null,he(e.files,s=>q((m(),p("div",{class:t(e.classes(e.n("file"),"var-elevation--2",[s.state==="loading",e.n("--loading")])),key:s.id,onClick:f=>e.preview(s)},[V("div",{class:t(e.n("file-name"))},be(s.name||s.url),3),e.removable?(m(),p("div",{key:0,class:t(e.n("file-close")),onClick:Ve(f=>e.handleRemove(s),["stop"])},[w(y,{class:t(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,ze)):R("v-if",!0),s.cover?(m(),p("img",{key:1,class:t(e.n("file-cover")),style:we({objectFit:s.fit}),src:s.cover,alt:s.name},null,14,Ae)):R("v-if",!0),V("div",{class:t(e.classes(e.n("file-indicator"),[s.state==="success",e.n("--success")],[s.state==="error",e.n("--error")]))},null,2)],10,Te)),[[h,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?q((m(),p("label",{key:0,for:e.id,class:t(e.classes([!e.$slots.default,`${e.n("action")} var-elevation--2`],[e.disabled||e.formDisabled,e.n("--disabled")]))},[V("input",{id:e.id,class:t(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:u[0]||(u[0]=(...s)=>e.handleChange&&e.handleChange(...s))},null,42,Ie),Re(e.$slots,"default",{},()=>[w(y,{class:t(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],10,Ne)),[[h,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):R("v-if",!0)],2),w(B,{"error-message":e.errorMessage,"maxlength-text":e.maxlengthText},null,8,["error-message","maxlength-text"]),w(F,{class:t(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":u[1]||(u[1]=s=>e.showPreview=s),onClosed:u[2]||(u[2]=s=>e.currentPreview=null)},{default:Pe(()=>{var s,f;return[e.currentPreview&&e.isHTMLSupportVideo((s=e.currentPreview)==null?void 0:s.url)?(m(),p("video",{key:0,class:t(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(f=e.currentPreview)==null?void 0:f.url},null,10,Me)):R("v-if",!0)]}),_:1},8,["class","show"])],2)}var T=ke(Le,[["render",Ee]]);T.install=function(e){e.component(T.name,T)};export{T as U};
